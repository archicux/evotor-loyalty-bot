// –°–∫—Ä–∏–ø—Ç –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –≠–≤–æ—Ç–æ—Ä ST730
// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫: loyalty.js

var LoyaltySystem = {
    // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ URL –ù–ê –í–ê–®! ‚ö†Ô∏è
    apiUrl: "https://–≤–∞—à-—Å–µ—Ä–≤–∏—Å.onrender.com/evotor/webhook",
    
    init: function() {
        console.log("üöÄ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏...");
        
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ API
        setTimeout(function() {
            try {
                LoyaltySystem.setupSystem();
            } catch(e) {
                console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
            }
        }, 2000);
    },
    
    setupSystem: function() {
        var api = require('evotor.api');
        
        // 1. –°–æ–∑–¥–∞–µ–º –ø–æ–ª–µ –¥–ª—è QR –∫–æ–¥–∞
        this.createQRField();
        
        // 2. –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è
        api.on('receiptClosed', function(receipt) {
            LoyaltySystem.processReceipt(receipt);
        });
        
        console.log("‚úÖ –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø—É—â–µ–Ω–∞");
    },
    
    createQRField: function() {
        try {
            var ui = require('evotor.api').ui;
            var screen = ui.currentScreen();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø—Ä–æ–¥–∞–∂
            if (screen && screen.layout) {
                // –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
                var qrField = ui.create('EditText', {
                    hint: "QR –∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞",
                    textSize: 18,
                    width: ui.MATCH_PARENT,
                    padding: [10, 10, 10, 10]
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —ç–∫—Ä–∞–Ω–∞
                if (screen.layout.addView) {
                    screen.layout.addView(qrField, 0);
                }
                
                this.qrField = qrField;
                console.log("‚úÖ –ü–æ–ª–µ –¥–ª—è QR –∫–æ–¥–∞ —Å–æ–∑–¥–∞–Ω–æ");
            }
        } catch(e) {
            console.log("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥");
        }
    },
    
    processReceipt: function(receipt) {
        if (!receipt || receipt.total <= 0) return;
        
        // –ü–æ–ª—É—á–∞–µ–º QR –∫–æ–¥
        var qrCode = "";
        if (this.qrField && this.qrField.getText) {
            qrCode = this.qrField.getText().trim();
        }
        
        if (!qrCode) {
            console.log("‚ö†Ô∏è QR –∫–æ–¥ –Ω–µ –≤–≤–µ–¥–µ–Ω");
            return;
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        var data = {
            document: {
                total: receipt.total,
                extra: {
                    clientCode: qrCode
                }
            }
        };
        
        console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:", data);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        var http = require('evotor.api').http;
        http.post({
            url: this.apiUrl,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data),
            callback: function(response) {
                console.log("üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", response);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞—Å—Å–∏—Ä—É
                var ui = require('evotor.api').ui;
                try {
                    if (response.code === 200) {
                        var result = JSON.parse(response.body);
                        if (result.status === 'ok') {
                            ui.showToast('‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ ' + result.points + ' –±–∞–ª–ª–æ–≤');
                        } else {
                            ui.showToast('‚ö†Ô∏è ' + result.message);
                        }
                    } else {
                        ui.showToast('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                    }
                } catch(e) {
                    console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞:", e);
                }
            }
        });
    }
};

// –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
LoyaltySystem.init();